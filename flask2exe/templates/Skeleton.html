{% extends "layout.html" %}

{% block body %}
<div class="content">
  <script type="text/javascript" language="javascript">
   
    document.addEventListener('keypress', (event) => {
      var keyName = event.key;
      console.log(`keypress:${keyName}`);

      if(keyName=='f'){
        console.log('press f');
        imgNext(1)
      }

      if(keyName=='j'){
        console.log('press f');
        imgNext(2)
      }

      if(keyName=='k'){
        console.log('press k');
        imgNext(0)
      }
    });
    

  </script>


  <div class="row">
    <div class="col-lg-2 col-md-6 col-sm-6">
      <form action="/skeleton_nextskip-0" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>NEXT</b><br>
        </button>
      </form>  
    </div>
    
    <div class="col-lg-2 col-md-6 col-sm-6">
      <form action="/skeleton_nextback-9" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>BACK</b><br>
        </button>
      </form>  
    </div>

    <div class="col-lg-2 col-md-6 col-sm-6">
      <form action="/skeleton_nextreload-9" method="POST">
        <button class="btn btn-primary btn-block alert2" type="submit" onclick="demo.showNotification2('top','left', 'save data')">
          <b>データの読み込み</b><br>
        </button>
      </form>  
    </div>

    <div class="col-lg-2 col-md-6 col-sm-6">
      <form action="/save_data_skel">
        <button class="btn btn-primary btn-block alert2" type="submit" onclick="demo.showNotification2('top','left', 'save data')">
          <b>データの保存</b><br>
        </button>
      </form>  
    </div>

  </div>

  <div class="row">
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_ready'] }}-{{ msg['type1'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>Ready</b><br><span style="font-size : 9pt">　</span>
        </button>
      </form>  
    </div>
  
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_ready'] }}-{{ msg['type2'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          Ready<br>
          <span style="font-size : 9pt">(Hiding)</span>
        </button>
      </form>  
    </div>
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_hc'] }}-{{ msg['type1'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>HC1</b><br><span style="font-size : 9pt">　</span>
        </button>
      </form>  
    </div>
  
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_hc'] }}-{{ msg['type2'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>HC1</b><br><span style="font-size : 9pt">(Hiding)</span>
        </button>
      </form>  
    </div>
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_to'] }}-{{ msg['type2'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>TO</b><br><span style="font-size : 9pt">　</span>
        </button>
      </form>  
    </div>
  
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_to'] }}-{{ msg['type1'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>TO</b><br><span style="font-size : 9pt">(Hiding)</span>
        </button>
      </form>  
    </div>
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_ms'] }}-{{ msg['type1'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>MS</b><br><span style="font-size : 9pt">　</span>
        </button>
      </form>  
    </div>
  
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_ms'] }}-{{ msg['type2'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>MS</b><br><span style="font-size : 9pt">(Hiding)</span>
        </button>
      </form>  
    </div>
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_hc2'] }}-{{ msg['type1'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>HC2</b><br><span style="font-size : 9pt">　</span>
        </button>
      </form>  
    </div>
  
    <div class="col-lg-1 col-md-6 col-sm-6">
      <form action="/skeleton_next{{ msg['output_hc2'] }}-{{ msg['type2'] }}" method="POST">
        <button class="btn btn-warning btn-block alert2" type="submit">
          <b>HC2</b><br><span style="font-size : 9pt">(Hiding)</span>
        </button>
      </form>  
    </div>
  </div>


  <div class="row">
    <div class="col-lg-7 col-md-7 col-sm-7">
      <div class="card card-stats">
        <div class="card-body" id='js-target'>
          <ul id="imgName" >{{ msg['img_name'] }}</ul>
          <hr>
          <div class="img_preview">
            <img src="data:image/png;base64,{{ img64['img_data'] }}" alt="img_data"  id="imgslot" class="skel_img"/>
            {% for skel_name, skel_key in msg['skel_name_key'] %}
              <div class="skel_point" id="{{ skel_key }}p"></div>
            {% endfor %}
          </div>
        </div>
        <div class="card-footer ">
          <hr>
          <div class="stats">
            <div id="imgState"><i class="fa fa-refresh"></i>{{ msg['img_path'] }}</div> 
          </div>
        </div>
      </div>
    </div>
  
    <div class="col-lg-3 col-md-3 col-sm-3">
      <div class="card card-stats">
        <div class="card-body check_box_anotate ">
          {% for skel_name, skel_key in msg['skel_name_key'] %}
            <input type="checkbox" id="{{ skel_key }}" value="{{ skel_key }}" onchange="myfunc(this.value, this.checked)"/>
            <label for="{{ skel_key }}" class="check_box_anotate">{{ skel_name }}</label>......<span class="skel_pos" id="{{ skel_key }}xy">(0,0)</span><hr class="skel_hr">
          {% endfor %}
          x:<span id="pos_x">0</span>  y:<span id="pos_y">0</span>
          <hr class="skel_hr">
          <input class="form-control" type="number" placeholder="count" value=0 name="skel_count" id="skel_count">
          <button class="btn btn-primary btn-block alert2" type="submit" onclick="skel_Confirm()">
            <b>確定(Ctrl+Q)</b><br>
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg-2 col-md-2 col-sm-2">
      <div class="card card-stats">
        <div class="card-body ">
          <ul class="side_text">現在の画像</ul>
          <hr>
          <center>
            <h3>{{ msg['count'] }}/{{ msg['path_len'] }}枚</h3>
          </center>
          <hr>
          <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: {{ msg['pvalue'] }}%;">
              <b>{{ msg['pvalue'] }}%</b>
            </div>
          </div>
          <hr>
        </div>
      </div>

      <div class="card card-stats">
        <div class="card-body ">
          <ul class="side_text">被験者</ulclass="side_text">
          <hr>
          <center>
            <div class="cp_ipselect cp_sl03">
              <select required id="sub">
                <option value="0" name="sample">Sample</option>
                {% for sub_id, sub_name in msg['sub_list'] %}
                  {% if msg['sub_id'] == sub_id %}
                    <option value="{{ sub_id }}" name="{{ sub_name }}" selected>{{ sub_name }}</option>  
                  {% else %}
                    <option value="{{ sub_id }}" name="{{ sub_name }}">{{ sub_name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              </div>
          </center>
          <hr>
        </div>
      </div>     
    </div>
  </div>
  </form>
</div>

<script type="text/javascript" language="javascript">
  let target = document.getElementById('js-target');
  // 要素を取得
  var divElement = document.getElementById('js-target') ;
  target.addEventListener('mousemove', getPosition);

  function getPosition(e) {
    let offsetX = e.offsetX; // =>要素左上からのx座標
    let offsetY = e.offsetY; // =>要素左上からのy座標
    let pageX = e.pageX; // =>ウィンドウ左上からのx座標
    let pageY = e.pageY; // =>ウィンドウ左上からのy座標
    let clientX = e.clientX; // =>ページ左上からのx座標
    let clientY = e.clientY; // =>ページ左上からのy座標

    $("#pos_x").text(offsetX);
    $("#pos_y").text(offsetY);
  }


  var target_skel_key = '#skel1xy';
  var target_key = 'skel1';

  target.addEventListener('click', setPosition);

  function setPosition(e) {
    let offsetX = e.offsetX; // =>要素左上からのx座標
    let offsetY = e.offsetY; // =>要素左上からのy座標
    let pageX = e.pageX; // =>ウィンドウ左上からのx座標
    let pageY = e.pageY; // =>ウィンドウ左上からのy座標
    let clientX = e.clientX; // =>ページ左上からのx座標
    let clientY = e.clientY; // =>ページ左上からのy座標

    $(target_skel_key).text('( ' + offsetX + ' , ' + offsetY + ' )');

    var target_point = target_key + "p"
    console.log("move point:" + target_point);

    var element = document.getElementById(target_point); 
    element.style.left = offsetX + 'px'; 
    element.style.top  = offsetY + 'px'; 

  }

  // 処理を定義
  var action = function() {
    
  }

  // イベントを設定 ( addEventListener )
  divElement.addEventListener( "mousemove", action ) ;
  //<button class="btn btn-primary btn-block" onclick="demo.showNotification('top','left')">Top Left</button>

  function myfunc(key, flag) {
    console.log("Key:" + key + " flag:" + flag);
    if(flag){
      target_skel_key = "#" + key + "xy";
      target_key = key
      console.log("target_skel_key:" + target_skel_key);
    }
  }

  function post_func(url, data) {
    // Postで送るパラメータを作成
    let formData = new FormData();
    console.log(">run post func");
    console.log(data);
    formData.append('param', data);
    fetch(url, {
      method: 'POST',  // methodを指定しないとGETになる
      body: formData,  // Postで送るパラメータを指定
    })
    .then(function() {  // Postした後に結果をGetする（コールバックなのでPostが実行完了してから実行される）
      
    });
    // ここにget_funcを書くとPostとGetがほぼ同時に行われてしまい、Post結果をGetできない
    // get_func('APIのGet用URL');
  }


  var key_box = [];
  
  function skel_Confirm(){
    demo.showNotification2('top','left', 'skel data Confirm......')
    console.log("on click skel_Confirm");
    
    var element = document.getElementById('skel_count');
    console.log(element); // handleClick()
    console.log(element.innerHTML); // handleClick()

    var sub_element = document.getElementById('sub');
    console.log(sub_element); // handleClick()
    console.log(sub_element.selectedIndex); // handleClick()
    console.log(sub_element[sub_element.selectedIndex].text); // handleClick()

    var skel_pos=document.querySelectorAll(".skel_pos");
    var skel_pos_box = [];

    for(var i=0;i<skel_pos.length;i++){
      skel_dict = {};
      skel_dict['skel_id'] = skel_pos[i].id;
      skel_dict['skel_key'] = skel_pos[i].id.split('xy')[0];

      var x = skel_pos[i].innerHTML.split(',')[0].split('(')[1];
      var y = skel_pos[i].innerHTML.split(',')[1].split(')')[0];

      skel_dict['x'] = x;
      skel_dict['y'] = y;
      console.log(skel_dict );
      skel_pos_box.push(skel_dict);
    }
    console.log(skel_pos_box);

    key_box[element.value] = skel_pos_box;
    dump_data = {};
    dump_data['img_name'] = "{{msg['img_name']}}";
    dump_data['key_data'] = key_box;
    dump_data['sub_id'] = sub_element.selectedIndex;
    dump_data['sub_name'] = sub_element[sub_element.selectedIndex].text;

    dump_data_json =  JSON.stringify(dump_data);
    console.log(dump_data_json);
    
    post_func('http://localhost:5050/skel_dump', dump_data_json)

  }
 
  // keydown 	キーが最初に押された時に発生
  document.addEventListener('keydown', (event) => {
    var keyName = event.key;

    if (event.ctrlKey) {
      console.log(`keydown:Ctrl + ${keyName}`);
      if(keyName=='q'){
        console.log(`press Q`);
        skel_Confirm();
      }
    } else if (event.shiftKey) {
      console.log(`keydown:Shift + ${keyName}`);
    } else {
      console.log(`keydown:${keyName}`);
    }
  });

  // keypress 	キーが修飾キー(※)でなかった場合に発
  document.addEventListener('keypress', (event) => {
    var keyName = event.key;

    if (event.ctrlKey) {
      console.log(`keypress:Ctrl + ${keyName}`);
    } else if (event.shiftKey) {
      console.log(`keypress:Shift + ${keyName}`);
    } else {
      console.log(`keypress:${keyName}`);
    }
  });
</script>
      
{% endblock %}
